<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamSync Pro | æé€ŸååŒ</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <style>
        :root { --sidebar-bg: #001529; --main-bg: #f0f2f5; }
        body { margin: 0; font-family: 'PingFang SC', Arial, sans-serif; background-color: var(--main-bg); }
        #app { height: 100vh; overflow: hidden; }
        .login-bg { height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); }
        .login-card { width: 400px; border-radius: 12px; }
        .app-layout { height: 100vh; display: flex; }
        .sidebar { width: 200px; background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; }
        .logo { height: 64px; line-height: 64px; text-align: center; font-size: 20px; font-weight: bold; color: #409EFF; border-bottom: 1px solid #002140; }
        .main-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .header { height: 60px; background: white; border-bottom: 1px solid #dcdfe6; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .content-area { flex: 1; overflow-y: auto; padding: 20px; }
        .project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .p-card { cursor: pointer; transition: 0.3s; position: relative; }
        .p-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
        
        /* çœ‹æ¿ä¸æˆå‘˜åˆ—è¡¨å¸ƒå±€ */
        .board-wrapper { display: flex; height: 100%; gap: 20px; }
        .kanban-container { flex: 1; display: flex; gap: 20px; overflow-x: auto; padding-bottom: 10px; }
        .kb-column { background: #ebedf0; border-radius: 10px; width: 300px; flex-shrink: 0; display: flex; flex-direction: column; }
        .kb-title { padding: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .task-list { padding: 10px; flex: 1; overflow-y: auto; }
        .task-item { background: white; border-radius: 8px; padding: 15px; margin-bottom: 12px; border: 1px solid #e6e6e6; }
        
        .member-sidebar { width: 240px; background: white; border-radius: 10px; padding: 20px; display: flex; flex-direction: column; box-shadow: 0 2px 12px 0 rgba(0,0,0,0.05); }
        .member-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px dotted #eee; }
        .user-link { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 5px 10px; border-radius: 20px; }
    </style>
</head>
<body>
    <div id="app">
        <!-- ç™»å½•æ³¨å†Œ -->
        <div v-if="!isLoggedIn" class="login-bg">
            <el-card class="login-card">
                <h2 style="text-align: center; color: #409EFF; margin-bottom: 20px;">TeamSync Pro</h2>
                <el-tabs v-model="authTab" stretch>
                    <el-tab-pane label="ç™»å½•" name="login">
                        <el-form :model="loginForm" label-position="top">
                            <el-form-item label="ç”¨æˆ·å"><el-input v-model="loginForm.username"></el-input></el-form-item>
                            <el-form-item label="å¯†ç "><el-input v-model="loginForm.password" type="password" show-password></el-input></el-form-item>
                            <el-button type="primary" style="width: 100%" @click="handleLogin">ç™»å½•</el-button>
                        </el-form>
                    </el-tab-pane>
                    <el-tab-pane label="æ³¨å†Œ" name="reg">
                        <el-form :model="regForm" label-position="top">
                            <el-form-item label="ç”¨æˆ·å"><el-input v-model="regForm.username"></el-input></el-form-item>
                            <el-form-item label="é‚®ç®±"><el-input v-model="regForm.email"></el-input></el-form-item>
                            <el-form-item label="å¯†ç "><el-input v-model="regForm.password" type="password" show-password></el-input></el-form-item>
                            <el-button type="success" style="width: 100%" @click="handleRegister">æ³¨å†Œ</el-button>
                        </el-form>
                    </el-tab-pane>
                </el-tabs>
            </el-card>
        </div>

        <div v-else class="app-layout">
            <div class="sidebar">
                <div class="logo">TEAMSYNC</div>
                <el-menu background-color="#001529" text-color="#fff" :default-active="activeMenu">
                    <el-menu-item index="hall" @click="changeView('hall')"><el-icon><Compass /></el-icon><span>é¡¹ç›®å¤§å…</span></el-menu-item>
                    <el-menu-item index="my" @click="changeView('my')"><el-icon><Menu /></el-icon><span>æˆ‘çš„é¡¹ç›®</span></el-menu-item>
                </el-menu>
            </div>

            <div class="main-container">
                <header class="header">
                    <div style="font-weight: bold; font-size: 16px;">{{ currentTitle }}</div>
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <el-popover placement="bottom" :width="300" trigger="click">
                            <template #reference><el-badge :value="invites.length" :hidden="invites.length === 0"><el-icon style="font-size: 20px; cursor: pointer;"><Bell /></el-icon></el-badge></template>
                            <div v-if="invites.length === 0" style="text-align: center; padding: 20px; color: #999;">æš‚æ— é‚€è¯·</div>
                            <div v-for="inv in invites" :key="inv.id" style="padding: 12px; border-bottom: 1px solid #f0f0f0;">
                                <div style="font-size: 14px; margin-bottom: 8px;">æ¥è‡ªé¡¹ç›®ï¼š<b>{{ inv.name }}</b></div>
                                <el-button size="small" type="primary" @click="handleInvite(inv.id, true)">æ¥å—</el-button>
                                <el-button size="small" type="danger" plain @click="handleInvite(inv.id, false)">æ‹’ç»</el-button>
                            </div>
                        </el-popover>
                        <el-dropdown @command="handleUserMenu">
                            <div class="user-link">
                                <el-avatar :size="30" :src="userInfo.avatar || 'https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png'"></el-avatar>
                                <span>{{ userInfo.username }}</span>
                            </div>
                            <template #dropdown><el-dropdown-menu><el-dropdown-item command="avatar">ä¿®æ”¹å¤´åƒ</el-dropdown-item><el-dropdown-item command="logout" divided>é€€å‡ºç™»å½•</el-dropdown-item></el-dropdown-menu></template>
                        </el-dropdown>
                    </div>
                </header>

                <div class="content-area">
                    <div v-if="view === 'my' || view === 'hall'">
                        <div style="margin-bottom: 20px; display: flex; justify-content: space-between;">
                            <span>{{ view === 'hall' ? 'å…¨æœå…¬å¼€é¡¹ç›®' : 'æˆ‘çš„é¡¹ç›®' }}</span>
                            <el-button v-if="view === 'my'" type="primary" icon="Plus" @click="showAddProject = true">åˆ›å»ºé¡¹ç›®</el-button>
                        </div>
                        <div class="project-grid">
                            <el-card v-for="p in projects" :key="p.id" class="p-card" @click="enterProject(p)">
                                <el-tag size="small" style="margin-bottom: 10px;" :type="p.type === 1 ? 'success' : 'info'">{{ p.type === 1 ? 'å…¬å¼€' : 'ç§æœ‰' }}</el-tag>
                                <h3>{{ p.name }}</h3>
                                <p style="font-size: 13px; color: #666; height: 36px; overflow: hidden;">{{ p.description }}</p>
                                <div style="font-size: 12px; color: #999;">è´Ÿè´£äºº ID: {{ p.ownerId }}</div>
                            </el-card>
                        </div>
                    </div>

                    <!-- çœ‹æ¿è§†å›¾ + æˆå‘˜åˆ—è¡¨ -->
                    <div v-if="view === 'board'" style="height: 100%; display: flex; flex-direction: column;">
                        <div style="margin-bottom: 20px; display: flex; justify-content: space-between;">
                            <el-button icon="Back" @click="changeView('my')">è¿”å›åˆ—è¡¨</el-button>
                            <div v-if="isOwner"><el-button type="success" icon="UserPlus" @click="showInvite = true">é‚€è¯·æˆå‘˜</el-button></div>
                        </div>
                        <div class="board-wrapper">
                            <!-- çœ‹æ¿ -->
                            <div class="kanban-container">
                                <div v-for="col in columns" :key="col.status" class="kb-column">
                                    <div class="kb-title">{{ col.label }} <el-button v-if="col.status === 0 && isOwner" icon="Plus" circle size="small" @click="showAddTask = true"></el-button></div>
                                    <div class="task-list">
                                        <div v-for="task in (boardData[col.status] || [])" :key="task.id" class="task-item">
                                            <div style="font-weight: bold; margin-bottom: 8px;">{{ task.name }}</div>
                                            <div style="font-size: 12px; color: #666; margin-bottom: 12px;">{{ task.description }}</div>
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <el-tag size="small" type="info">{{ task.assigneeId ? 'æ‰§è¡ŒID: '+task.assigneeId : 'æœªæŒ‡æ´¾' }}</el-tag>
                                                <div v-if="isOwner || task.assigneeId == userInfo.id">
                                                    <el-button-group>
                                                        <el-button v-if="task.status > 0" icon="ArrowLeft" size="small" circle @click="moveTask(task, task.status - 1)"></el-button>
                                                        <el-button v-if="isOwner" icon="User" size="small" @click="assignTask(task)"></el-button>
                                                        <el-button v-if="task.status < 2" icon="ArrowRight" size="small" circle @click="moveTask(task, task.status + 1)"></el-button>
                                                    </el-button-group>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- ğŸ’¡ æˆå‘˜åˆ—è¡¨ä¾§è¾¹æ  -->
                            <div class="member-sidebar">
                                <div style="font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 5px;">
                                    <el-icon color="#409EFF"><UserFilled /></el-icon> é¡¹ç›®æˆå‘˜
                                </div>
                                <div class="task-list">
                                    <div v-for="m in members" :key="m.userId" class="member-item">
                                        <el-avatar :size="30" :src="m.avatar || 'https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png'"></el-avatar>
                                        <div style="flex: 1; overflow: hidden;">
                                            <div style="font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ m.username }}</div>
                                            <div style="font-size: 11px; color: #999;">ID: {{ m.userId }} | {{ m.role }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¼¹çª— -->
        <el-dialog v-model="showAddProject" title="æ–°å»ºé¡¹ç›®" width="400px">
            <el-form :model="projectForm" label-position="top">
                <el-form-item label="é¡¹ç›®åç§°"><el-input v-model="projectForm.name"></el-input></el-form-item>
                <el-form-item label="æè¿°"><el-input v-model="projectForm.description" type="textarea"></el-input></el-form-item>
                <el-form-item label="ç±»å‹"><el-radio-group v-model="projectForm.type"><el-radio :label="0">ç§æœ‰</el-radio><el-radio :label="1">å…¬å¼€</el-radio></el-radio-group></el-form-item>
            </el-form>
            <template #footer><el-button @click="showAddProject=false">å–æ¶ˆ</el-button><el-button type="primary" @click="doAddProject">ç¡®å®š</el-button></template>
        </el-dialog>
        <el-dialog v-model="showAddTask" title="åˆ›å»ºä»»åŠ¡" width="400px">
            <el-form :model="taskForm" label-position="top">
                <el-form-item label="ä»»åŠ¡æ ‡é¢˜"><el-input v-model="taskForm.name"></el-input></el-form-item>
                <el-form-item label="æè¿°"><el-input v-model="taskForm.description" type="textarea"></el-input></el-form-item>
                <el-form-item label="æ‰§è¡Œè€… ID"><el-input v-model="taskForm.assigneeId"></el-input></el-form-item>
            </el-form>
            <template #footer><el-button @click="showAddTask=false">å–æ¶ˆ</el-button><el-button type="primary" @click="doAddTask">ç¡®å®š</el-button></template>
        </el-dialog>
        <el-dialog v-model="showInvite" title="é‚€è¯·æˆå‘˜" width="350px">
            <el-input v-model="inviteUsername" placeholder="å¯¹æ–¹ç”¨æˆ·å"></el-input>
            <template #footer><el-button type="primary" style="width: 100%" @click="doInvite">å‘é€é‚€è¯·</el-button></template>
        </el-dialog>
        <input type="file" ref="fileInput" style="display: none" @change="onFileChange" accept="image/*">
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, computed } = Vue;
        const { ElMessage, ElNotification, ElMessageBox } = ElementPlus;

        createApp({
            setup() {
                const isLoggedIn = ref(!!localStorage.getItem('token'));
                const loading = ref(false);
                const authTab = ref('login');
                const view = ref('hall');
                const activeMenu = ref('hall');
                const userInfo = reactive({ id: localStorage.getItem('userId'), username: localStorage.getItem('username'), avatar: localStorage.getItem('avatar') });
                
                const projects = ref([]);
                const invites = ref([]);
                const members = ref([]);
                const boardData = ref({});
                const currentProject = ref({});
                const ws = ref(null);

                const loginForm = reactive({ username: '', password: '' });
                const regForm = reactive({ username: '', email: '', password: '' });
                const projectForm = reactive({ name: '', description: '', type: 0 });
                const taskForm = reactive({ name: '', description: '', assigneeId: null });
                const inviteUsername = ref('');

                const showAddProject = ref(false);
                const showAddTask = ref(false);
                const showInvite = ref(false);
                const fileInput = ref(null);

                const columns = [{status:0, label:'å¾…åŠ'}, {status:1, label:'è¿›è¡Œä¸­'}, {status:2, label:'å·²å®Œæˆ'}];
                const currentTitle = computed(() => (view.value === 'my' ? 'æˆ‘çš„é¡¹ç›®' : view.value === 'hall' ? 'é¡¹ç›®å¤§å…' : 'é¡¹ç›®çœ‹æ¿'));
                const isOwner = computed(() => currentProject.value.ownerId == userInfo.id);

                axios.defaults.baseURL = '';
                axios.interceptors.request.use(cfg => { if(localStorage.getItem('token')) cfg.headers.token = localStorage.getItem('token'); return cfg; });
                axios.interceptors.response.use(res => { if(res.data.code !== 200) { ElMessage.error(res.data.msg); return Promise.reject(); } return res.data; }, err => { if(err.response?.status === 401) { localStorage.clear(); isLoggedIn.value = false; } return Promise.reject(err); });

                const handleLogin = async () => { const res = await axios.post('/user/login', loginForm); localStorage.setItem('token', res.data.token); localStorage.setItem('userId', res.data.id); localStorage.setItem('username', res.data.username); localStorage.setItem('avatar', res.data.avatar || ''); window.location.reload(); };
                const handleRegister = async () => { await axios.post('/user/register', regForm); ElMessage.success('æ³¨å†ŒæˆåŠŸ'); authTab.value = 'login'; };
                const changeView = (v) => { view.value = v; activeMenu.value = v; if(v === 'my') loadMyProjects(); if(v === 'hall') loadHall(); };
                const loadMyProjects = async () => { const res = await axios.get('/project/list'); projects.value = res.data; };
                const loadHall = async () => { const res = await axios.get('/project/hall'); projects.value = res.data; };
                const enterProject = (p) => { currentProject.value = p; view.value = 'board'; loadBoard(p.id); loadMembers(p.id); initWS(p.id); };
                const loadBoard = async (pid) => { const res = await axios.get(`/task/board/${pid}`); boardData.value = res.data; };
                const loadMembers = async (pid) => { const res = await axios.get(`/project/members/${pid}`); members.value = res.data; };
                const doAddProject = async () => { await axios.post('/project/create', projectForm); showAddProject.value = false; changeView('my'); };
                const doAddTask = async () => { await axios.post('/task/create', { ...taskForm, projectId: currentProject.value.id }); showAddTask.value = false; loadBoard(currentProject.value.id); };
                const moveTask = async (t, s, a = null) => { await axios.post('/task/update', { taskId: t.id, status: s, assigneeId: a }); loadBoard(currentProject.value.id); };
                const assignTask = (t) => { ElMessageBox.prompt('è¾“å…¥æ‰§è¡Œè€… ID', 'æŒ‡æ´¾').then(({ value }) => { if(value) moveTask(t, t.status, value); }); };
                const doInvite = async () => { await axios.post('/project/invite', { projectId: currentProject.value.id, username: inviteUsername.value }); showInvite.value = false; ElMessage.success('é‚€è¯·å·²å‘å‡º'); };
                const handleInvite = async (pid, accept) => { await axios.post('/project/invite/handle', { projectId: pid, accept }); loadInvites(); if(accept) loadMyProjects(); };
                const loadInvites = async () => { const res = await axios.get('/project/invite/list'); invites.value = res.data; };
                const handleUserMenu = (cmd) => { if(cmd === 'logout') { localStorage.clear(); location.reload(); } if(cmd === 'avatar') fileInput.value.click(); };
                const onFileChange = async (e) => { const file = e.target.files[0]; if(!file) return; const fd = new FormData(); fd.append('file', file); const res = await axios.post('/user/upload/avatar', fd); userInfo.avatar = res.data; localStorage.setItem('avatar', res.data); };
                const initWS = (pid) => { if(ws.value) ws.value.close(); ws.value = new WebSocket(`ws://${location.host}/ws/${pid}/${parseInt(userInfo.id)}`); ws.value.onmessage = (e) => { if(e.data.includes('refresh')) { ElNotification({ title: 'åŒæ­¥', message: 'çœ‹æ¿æ›´æ–°', type: 'info', position: 'bottom-right' }); loadBoard(pid); } }; };

                onMounted(() => { if(isLoggedIn.value) { changeView('hall'); loadInvites(); } });

                return {
                    isLoggedIn, authTab, loading, view, activeMenu, userInfo, projects, invites, members, boardData,
                    loginForm, regForm, projectForm, taskForm, inviteUsername, showAddProject, showAddTask, showInvite,
                    currentTitle, columns, isOwner, fileInput,
                    handleLogin, handleRegister, changeView, enterProject, doAddProject, doAddTask, moveTask, assignTask,
                    doInvite, handleInvite, handleUserMenu, onFileChange
                };
            }
        }).use(ElementPlus).component('Menu', ElementPlusIconsVue.Menu).component('Compass', ElementPlusIconsVue.Compass).component('Plus', ElementPlusIconsVue.Plus).component('Bell', ElementPlusIconsVue.Bell).component('Back', ElementPlusIconsVue.Back).component('ArrowRight', ElementPlusIconsVue.ArrowRight).component('ArrowLeft', ElementPlusIconsVue.ArrowLeft).component('User', ElementPlusIconsVue.User).component('UserFilled', ElementPlusIconsVue.UserFilled).mount('#app');
    </script>
</body>
</html>