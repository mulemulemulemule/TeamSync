<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamSync Pro | 极速协同</title>
    <!-- 引入资源 -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <style>
        :root { --sidebar-bg: #001529; --main-bg: #f0f2f5; }
        body { margin: 0; font-family: 'PingFang SC', Arial, sans-serif; background-color: var(--main-bg); }
        #app { height: 100vh; overflow: hidden; }
        
        .login-bg { height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); }
        .login-card { width: 400px; border-radius: 12px; }

        .app-layout { height: 100vh; display: flex; }
        .sidebar { width: 200px; background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; }
        .logo { height: 64px; line-height: 64px; text-align: center; font-size: 20px; font-weight: bold; color: #409EFF; border-bottom: 1px solid #002140; }
        .main-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .header { height: 60px; background: white; border-bottom: 1px solid #dcdfe6; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; }

        .content-area { flex: 1; overflow-y: auto; padding: 24px; }
        .project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; }
        
        /* 卡片点赞区 */
        .p-card { cursor: pointer; transition: 0.3s; position: relative; padding-bottom: 45px; height: 180px; }
        .p-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
        .card-footer { position: absolute; bottom: 0; left: 0; right: 0; height: 45px; border-top: 1px solid #f0f0f0; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; background: #fafafa; }
        .like-btn { cursor: pointer; display: flex; align-items: center; gap: 4px; color: #666; transition: 0.2s; }
        .like-btn:hover { color: #F56C6C; }
        .like-btn.is-liked { color: #F56C6C; font-weight: bold; }

        /* 看板与侧边栏 */
        .board-wrapper { display: flex; height: 100%; gap: 20px; }
        .kanban-container { flex: 1; display: flex; gap: 20px; overflow-x: auto; padding-bottom: 10px; }
        .kb-column { background: #ebedf0; border-radius: 10px; width: 320px; flex-shrink: 0; display: flex; flex-direction: column; }
        .kb-title { padding: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .task-list { padding: 10px; flex: 1; overflow-y: auto; }
        .task-item { background: white; border-radius: 8px; padding: 15px; margin-bottom: 12px; border: 1px solid #e6e6e6; }
        
        .member-sidebar { width: 240px; background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.05); }
        .member-item { display: flex; align-items: center; gap: 10px; padding: 12px 0; border-bottom: 1px dotted #eee; }
        .user-link { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 5px 10px; border-radius: 20px; }
    </style>
</head>
<body>
    <div id="app">
        <!-- 登录注册 -->
        <div v-if="!isLoggedIn" class="login-bg">
            <el-card class="login-card">
                <h2 style="text-align: center; color: #409EFF; margin-bottom: 25px;">TeamSync Pro</h2>
                <el-tabs v-model="authTab" stretch>
                    <el-tab-pane label="登录" name="login">
                        <el-form :model="loginForm" label-position="top">
                            <el-form-item label="用户名"><el-input v-model="loginForm.username" prefix-icon="User"></el-input></el-form-item>
                            <el-form-item label="密码"><el-input v-model="loginForm.password" type="password" prefix-icon="Lock" show-password></el-input></el-form-item>
                            <el-button type="primary" style="width: 100%" @click="handleLogin" :loading="loading">立即登录</el-button>
                        </el-form>
                    </el-tab-pane>
                    <el-tab-pane label="注册" name="reg">
                        <el-form :model="regForm" label-position="top">
                            <el-form-item label="用户名"><el-input v-model="regForm.username"></el-input></el-form-item>
                            <el-form-item label="邮箱"><el-input v-model="regForm.email"></el-input></el-form-item>
                            <el-form-item label="密码"><el-input v-model="regForm.password" type="password" show-password></el-input></el-form-item>
                            <el-button type="success" style="width: 100%" @click="handleRegister" :loading="loading">确认注册</el-button>
                        </el-form>
                    </el-tab-pane>
                </el-tabs>
            </el-card>
        </div>

        <div v-else class="app-layout">
            <div class="sidebar">
                <div class="logo">TEAMSYNC</div>
                <el-menu background-color="#001529" text-color="#fff" :default-active="activeMenu">
                    <el-menu-item index="hall" @click="changeView('hall')"><el-icon><Compass /></el-icon><span>项目大厅</span></el-menu-item>
                    <el-menu-item index="my" @click="changeView('my')"><el-icon><Menu /></el-icon><span>我的项目</span></el-menu-item>
                </el-menu>
            </div>

            <div class="main-container">
                <header class="header">
                    <div style="font-weight: bold; font-size: 18px;">{{ currentTitle }}</div>
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <!-- 邀请铃铛 -->
                        <el-popover placement="bottom" :width="300" trigger="click">
                            <template #reference><el-badge :value="invites.length" :hidden="invites.length === 0"><el-icon style="font-size: 20px; cursor: pointer;"><Bell /></el-icon></el-badge></template>
                            <div v-if="invites.length === 0" style="text-align: center; padding: 20px; color: #999;">没有新邀请</div>
                            <div v-for="inv in invites" :key="inv.id" style="padding: 12px; border-bottom: 1px solid #f0f0f0;">
                                <div style="font-size: 14px; margin-bottom: 8px;">加入请求：<b>{{ inv.name }}</b></div>
                                <el-button size="small" type="primary" @click="handleInvite(inv.id, true)">接受</el-button>
                                <el-button size="small" type="danger" plain @click="handleInvite(inv.id, false)">忽略</el-button>
                            </div>
                        </el-popover>
                        <!-- 用户中心 -->
                        <el-dropdown @command="handleUserMenu">
                            <div class="user-link">
                                <el-avatar :size="30" :src="userInfo.avatar || 'https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png'"></el-avatar>
                                <span style="font-size: 14px;">{{ userInfo.username }}</span>
                            </div>
                            <template #dropdown><el-dropdown-menu><el-dropdown-item command="avatar">修改头像</el-dropdown-item><el-dropdown-item command="logout" divided>退出登录</el-dropdown-item></el-dropdown-menu></template>
                        </el-dropdown>
                    </div>
                </header>

                <div class="content-area">
                    <!-- 列表页 (大厅带搜索 / 我的) -->
                    <div v-if="view === 'my' || view === 'hall'">
                        <div style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span style="font-weight: bold; color: #606266;">{{ view === 'hall' ? '全服公开项目' : '我加入的项目' }}</span>
                                <el-input v-if="view === 'hall'" v-model="searchKey" placeholder="输入关键词搜索..." style="width: 250px" @input="loadHall" clearable prefix-icon="Search"></el-input>
                            </div>
                            <el-button v-if="view === 'my'" type="primary" icon="Plus" @click="showAddProject = true">开启新项目</el-button>
                        </div>
                        <div class="project-grid">
                            <el-card v-for="p in projects" :key="p.id" class="p-card" shadow="hover" :body-style="{ padding: '20px' }">
                                <div @click="enterProject(p)" style="height: 100px;">
                                    <el-tag size="small" style="margin-bottom: 10px;" :type="p.type === 1 ? 'success' : 'info'">{{ p.type === 1 ? '公开' : '私有' }}</el-tag>
                                    <h3 style="margin: 0 0 10px;">{{ p.name }}</h3>
                                    <p style="font-size: 13px; color: #666; height: 36px; overflow: hidden; line-height: 1.5;">{{ p.description || '暂无项目描述' }}</p>
                                </div>
                                <div class="card-footer">
                                    <span style="font-size: 12px; color: #999;">负责人 ID: {{ p.ownerId }}</span>
                                    <div class="like-btn" :class="{ 'is-liked': p.isLiked }" @click.stop="toggleLike(p)">
                                        <el-icon><StarFilled v-if="p.isLiked"/><Star v-else/></el-icon>
                                        <span>{{ p.likeCount || 0 }}</span>
                                    </div>
                                </div>
                            </el-card>
                        </div>
                    </div>

                    <!-- 看板页 -->
                    <div v-if="view === 'board'" style="height: 100%; display: flex; flex-direction: column;">
                        <div style="margin-bottom: 20px; display: flex; justify-content: space-between;">
                            <el-button icon="Back" @click="changeView('my')">返回列表</el-button>
                            <div v-if="isOwner"><el-button type="success" icon="UserPlus" @click="showInvite = true">邀请成员</el-button></div>
                        </div>
                        <div class="board-wrapper">
                            <div class="kanban-container">
                                <div v-for="col in columns" :key="col.status" class="kb-column">
                                    <div class="kb-title">{{ col.label }} <el-button v-if="col.status === 0 && isOwner" icon="Plus" circle size="small" @click="showAddTask = true"></el-button></div>
                                    <div class="task-list">
                                        <div v-for="task in (boardData[col.status] || [])" :key="task.id" class="task-item">
                                            <div style="font-weight: bold; margin-bottom: 8px;">{{ task.name }}</div>
                                            <div style="font-size: 12px; color: #666; margin-bottom: 15px; min-height: 20px;">{{ task.description }}</div>
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <el-tag size="small" type="info">{{ task.assigneeId ? '执行ID: '+task.assigneeId : '未指派' }}</el-tag>
                                                <div v-if="isOwner || task.assigneeId == userInfo.id">
                                                    <el-button-group>
                                                        <el-button v-if="task.status > 0" icon="ArrowLeft" size="small" circle @click="moveTask(task, task.status - 1)"></el-button>
                                                        <el-button v-if="isOwner" icon="User" size="small" @click="assignTask(task)"></el-button>
                                                        <el-button v-if="task.status < 2" icon="ArrowRight" size="small" circle @click="moveTask(task, task.status + 1)"></el-button>
                                                    </el-button-group>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- 成员列表 -->
                            <div class="member-sidebar">
                                <h4 style="margin-top: 0; display: flex; align-items: center; gap: 8px;"><el-icon><UserFilled /></el-icon>项目成员</h4>
                                <div v-for="m in members" :key="m.userId" class="member-item">
                                    <el-avatar :size="28" :src="m.avatar"></el-avatar>
                                    <div style="overflow: hidden;">
                                        <div style="font-size: 13px; font-weight: 500;">{{ m.username }}</div>
                                        <div style="font-size: 10px; color: #999;">ID: {{ m.userId }} | {{ m.role }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 弹窗集群 -->
        <el-dialog v-model="showAddProject" title="创建新项目" width="400px">
            <el-form :model="projectForm" label-position="top">
                <el-form-item label="项目名称"><el-input v-model="projectForm.name"></el-input></el-form-item>
                <el-form-item label="描述"><el-input v-model="projectForm.description" type="textarea"></el-input></el-form-item>
                <el-form-item label="公开性"><el-radio-group v-model="projectForm.type"><el-radio :label="0">私有</el-radio><el-radio :label="1">公开</el-radio></el-radio-group></el-form-item>
            </el-form>
            <template #footer><el-button @click="showAddProject=false">取消</el-button><el-button type="primary" @click="doAddProject">开始创建</el-button></template>
        </el-dialog>
        <el-dialog v-model="showAddTask" title="指派新任务" width="400px">
            <el-form :model="taskForm" label-position="top">
                <el-form-item label="任务标题"><el-input v-model="taskForm.name"></el-input></el-form-item>
                <el-form-item label="详情描述"><el-input v-model="taskForm.description" type="textarea"></el-input></el-form-item>
                <el-form-item label="执行人 ID"><el-input v-model="taskForm.assigneeId" placeholder="不填则默认为空"></el-input></el-form-item>
            </el-form>
            <template #footer><el-button @click="showAddTask=false">取消</el-button><el-button type="primary" @click="doAddTask">确定发布</el-button></template>
        </el-dialog>
        <el-dialog v-model="showInvite" title="邀请成员" width="350px">
            <el-input v-model="inviteUser" placeholder="输入被邀请人的用户名"></el-input>
            <template #footer><el-button type="primary" style="width: 100%" @click="doInvite">发送邀请</el-button></template>
        </el-dialog>
        <input type="file" ref="fileInput" style="display: none" @change="onFileChange" accept="image/*">
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, computed } = Vue;
        const { ElMessage, ElNotification, ElMessageBox } = ElementPlus;

        createApp({
            setup() {
                const isLoggedIn = ref(!!localStorage.getItem('token'));
                const loading = ref(false);
                const authTab = ref('login');
                const view = ref('hall');
                const activeMenu = ref('hall');
                const searchKey = ref('');
                const userInfo = reactive({ id: localStorage.getItem('userId'), username: localStorage.getItem('username'), avatar: localStorage.getItem('avatar') });
                
                const projects = ref([]);
                const invites = ref([]);
                const members = ref([]);
                const boardData = ref({});
                const currentProject = ref({});
                const ws = ref(null);

                const loginForm = reactive({ username: '', password: '' });
                const regForm = reactive({ username: '', email: '', password: '' });
                const projectForm = reactive({ name: '', description: '', type: 0 });
                const taskForm = reactive({ name: '', description: '', assigneeId: null });
                const inviteUser = ref('');

                const showAddProject = ref(false);
                const showAddTask = ref(false);
                const showInvite = ref(false);
                const fileInput = ref(null);

                const columns = [{status:0, label:'待办'}, {status:1, label:'进行中'}, {status:2, label:'已完成'}];
                const currentTitle = computed(() => (view.value === 'my' ? '个人工作台' : view.value === 'hall' ? '项目广场' : '看板视图'));
                const isOwner = computed(() => currentProject.value.ownerId == userInfo.id);

                axios.defaults.baseURL = '';
                axios.interceptors.request.use(cfg => { if(localStorage.getItem('token')) cfg.headers.token = localStorage.getItem('token'); return cfg; });
                axios.interceptors.response.use(res => { if(res.data.code !== 200) { ElMessage.error(res.data.msg); return Promise.reject(); } return res.data; }, err => { if(err.response?.status === 401) { localStorage.clear(); isLoggedIn.value = false; } return Promise.reject(err); });

                const handleLogin = async () => {
                    loading.value = true;
                    try {
                        const res = await axios.post('/user/login', loginForm);
                        localStorage.setItem('token', res.data.token);
                        localStorage.setItem('userId', res.data.id);
                        localStorage.setItem('username', res.data.username);
                        localStorage.setItem('avatar', res.data.avatar || '');
                        window.location.reload(); 
                    } finally { loading.value = false; }
                };

                const handleRegister = async () => { await axios.post('/user/register', regForm); ElMessage.success('注册成功'); authTab.value = 'login'; };
                const changeView = (v) => { view.value = v; activeMenu.value = v; if(v === 'my') loadMyProjects(); if(v === 'hall') loadHall(); };
                const loadMyProjects = async () => { const res = await axios.get('/project/list'); projects.value = res.data; };
                const loadHall = async () => { const res = await axios.get('/project/hall', { params: { keyword: searchKey.value } }); projects.value = res.data; };
                const toggleLike = async (p) => { await axios.post(`/project/like/${p.id}`); p.isLiked = !p.isLiked; p.likeCount += (p.isLiked ? 1 : -1); };
                const enterProject = (p) => { currentProject.value = p; view.value = 'board'; loadBoard(p.id); loadMembers(p.id); initWS(p.id); };
                const loadBoard = async (pid) => { const res = await axios.get(`/task/board/${pid}`); boardData.value = res.data; };
                const loadMembers = async (pid) => { const res = await axios.get(`/project/members/${pid}`); members.value = res.data; };
                const doAddProject = async () => { await axios.post('/project/create', projectForm); showAddProject.value = false; changeView('my'); };
                const doAddTask = async () => { await axios.post('/task/create', { ...taskForm, projectId: currentProject.value.id }); showAddTask.value = false; loadBoard(currentProject.value.id); };
                const moveTask = async (t, s, a = null) => { await axios.post('/task/update', { taskId: t.id, status: s, assigneeId: a }); loadBoard(currentProject.value.id); };
                const assignTask = (t) => { ElMessageBox.prompt('输入执行者 ID', '指派任务').then(({ value }) => { if(value) moveTask(t, t.status, value); }); };
                const doInvite = async () => { await axios.post('/project/invite', { projectId: currentProject.value.id, username: inviteUser.value }); showInvite.value = false; ElMessage.success('邀请已发出'); };
                const handleInvite = async (pid, accept) => { await axios.post('/project/invite/handle', { projectId: pid, accept }); loadInvites(); if(accept) loadMyProjects(); };
                const loadInvites = async () => { const res = await axios.get('/project/invite/list'); invites.value = res.data; };
                const handleUserMenu = (cmd) => { if(cmd === 'logout') { localStorage.clear(); location.reload(); } if(cmd === 'avatar') fileInput.value.click(); };
                const onFileChange = async (e) => { const file = e.target.files[0]; if(!file) return; const fd = new FormData(); fd.append('file', file); const res = await axios.post('/user/upload/avatar', fd); userInfo.avatar = res.data; localStorage.setItem('avatar', res.data); ElMessage.success('头像更新成功'); };
                const initWS = (pid) => { if(ws.value) ws.value.close(); ws.value = new WebSocket(`ws://${location.host}/ws/${pid}/${parseInt(userInfo.id)}`); ws.value.onmessage = (e) => { if(e.data.includes('refresh')) { ElNotification({ title: '数据更新', message: '检测到项目变动，看板已自动刷新', type: 'info', position: 'bottom-right' }); loadBoard(pid); } }; };

                onMounted(() => { if(isLoggedIn.value) { changeView('hall'); loadInvites(); } });

                return {
                    isLoggedIn, authTab, loading, view, activeMenu, userInfo, projects, invites, members, boardData,
                    loginForm, regForm, projectForm, taskForm, inviteUser, showAddProject, showAddTask, showInvite,
                    currentTitle, columns, isOwner, fileInput, searchKey,
                    handleLogin, handleRegister, changeView, enterProject, doAddProject, doAddTask, moveTask, assignTask,
                    doInvite, handleInvite, handleUserMenu, onFileChange, loadHall, toggleLike
                };
            }
        }).use(ElementPlus).component('Menu', ElementPlusIconsVue.Menu).component('Compass', ElementPlusIconsVue.Compass).component('Plus', ElementPlusIconsVue.Plus).component('Bell', ElementPlusIconsVue.Bell).component('Back', ElementPlusIconsVue.Back).component('ArrowRight', ElementPlusIconsVue.ArrowRight).component('ArrowLeft', ElementPlusIconsVue.ArrowLeft).component('User', ElementPlusIconsVue.User).component('Search', ElementPlusIconsVue.Search).component('Star', ElementPlusIconsVue.Star).component('StarFilled', ElementPlusIconsVue.StarFilled).component('UserPlus', ElementPlusIconsVue.UserFilled).component('UserFilled', ElementPlusIconsVue.UserFilled).mount('#app');
    </script>
</body>
</html>
