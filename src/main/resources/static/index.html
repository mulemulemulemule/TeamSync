<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamSync Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <style>
        :root { --sidebar-bg: #001529; --main-bg: #f0f2f5; }
        body { margin: 0; font-family: 'PingFang SC', sans-serif; background-color: var(--main-bg); }
        #app { height: 100vh; overflow: hidden; }
        .login-bg { height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); }
        .login-card { width: 400px; border-radius: 12px; }
        .app-layout { height: 100vh; display: flex; }
        .sidebar { width: 200px; background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; }
        .logo { height: 64px; line-height: 64px; text-align: center; font-size: 18px; font-weight: bold; color: #F56C6C; border-bottom: 1px solid #002140; }
        .main-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .header { height: 60px; background: white; border-bottom: 1px solid #dcdfe6; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .content-area { flex: 1; overflow-y: auto; padding: 20px; }
        .project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .p-card { cursor: pointer; transition: 0.3s; position: relative; padding-bottom: 45px; height: 180px; }
        .p-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
        .card-footer { position: absolute; bottom: 0; left: 0; right: 0; height: 45px; border-top: 1px solid #f0f0f0; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; background: #fafafa; }
        .board-wrapper { display: flex; height: 100%; gap: 20px; }
        .kanban-container { flex: 1; display: flex; gap: 20px; overflow-x: auto; padding-bottom: 10px; }
        .kb-column { background: #ebedf0; border-radius: 10px; width: 300px; flex-shrink: 0; display: flex; flex-direction: column; }
        .kb-title { padding: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .task-list { padding: 10px; flex: 1; overflow-y: auto; }
        .task-item { background: white; border-radius: 8px; padding: 15px; margin-bottom: 12px; cursor: pointer; border: 1px solid #e6e6e6; }
        .member-sidebar { width: 240px; background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.05); }
        .member-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px dotted #eee; }
        
        /* ËØ¶ÊÉÖÈ°µÊ†∑Âºè */
        .task-detail-layout { display: flex; gap: 20px; height: 500px; }
        .detail-left { flex: 1; display: flex; flex-direction: column; gap: 15px; border-right: 1px solid #eee; padding-right: 20px; overflow-y: auto; }
        .detail-right { width: 300px; display: flex; flex-direction: column; }
        .comment-list { flex: 1; overflow-y: auto; padding-right: 5px; }
        .comment-item { margin-bottom: 15px; display: flex; gap: 10px; position: relative; }
        .comment-item:hover .comment-del-btn { display: block; }
        .comment-content { background: #f4f4f5; padding: 8px 12px; border-radius: 8px; font-size: 13px; color: #303133; line-height: 1.4; }
        .comment-meta { font-size: 11px; color: #999; margin-bottom: 2px; }
        .comment-del-btn { position: absolute; top: 0; right: 0; display: none; color: #F56C6C; cursor: pointer; font-size: 12px; }

        .like-btn { cursor: pointer; display: flex; align-items: center; gap: 4px; color: #666; }
        .like-btn.is-liked { color: #F56C6C; }
        .del-btn { position: absolute; top: 10px; right: 10px; display: none; color: #F56C6C; }
        .p-card:hover .del-btn { display: block; }
        .file-box { background: #ecf5ff; padding: 10px; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; color: #409EFF; margin-top: 5px; border: 1px dashed #409EFF; }
    </style>
</head>
<body>
    <div id="app">
        <!-- ÁôªÂΩï (Áï•) -->
        <div v-if="!isLoggedIn" class="login-bg">
            <el-card class="login-card">
                <h2 style="text-align: center; color: #F56C6C;">TeamSync Pro</h2>
                <el-tabs v-model="authTab" stretch>
                    <el-tab-pane label="ÁôªÂΩï" name="login">
                        <el-form :model="loginForm"><el-form-item><el-input v-model="loginForm.username" placeholder="Áî®Êà∑Âêç" prefix-icon="User"></el-input></el-form-item><el-form-item><el-input v-model="loginForm.password" type="password" placeholder="ÂØÜÁ†Å" prefix-icon="Lock"></el-input></el-form-item><el-button type="danger" style="width: 100%" @click="handleLogin">Ëøõ Âéª</el-button></el-form>
                    </el-tab-pane>
                    <el-tab-pane label="Ê≥®ÂÜå" name="reg">
                        <el-form :model="regForm"><el-form-item><el-input v-model="regForm.username" placeholder="Áî®Êà∑Âêç"></el-input></el-form-item><el-form-item><el-input v-model="regForm.email" placeholder="ÈÇÆÁÆ±"></el-input></el-form-item><el-form-item><el-input v-model="regForm.password" type="password" placeholder="ÂØÜÁ†Å"></el-input></el-form-item><el-button type="success" style="width: 100%" @click="handleRegister">Êêû‰∏™Âè∑</el-button></el-form>
                    </el-tab-pane>
                </el-tabs>
            </el-card>
        </div>

        <div v-else class="app-layout">
            <div class="sidebar">
                <div class="logo">‰∏çÂ•ΩÁî®ÂçèÂêå</div>
                <el-menu background-color="#001529" text-color="#fff" :default-active="activeMenu">
                    <el-menu-item index="hall" @click="changeView('hall')"><el-icon><Compass /></el-icon><span>È°πÁõÆÂ§ßÂéÖ</span></el-menu-item>
                    <el-menu-item index="my" @click="changeView('my')"><el-icon><Menu /></el-icon><span>ÊàëÁöÑÈ°πÁõÆ</span></el-menu-item>
                </el-menu>
            </div>

            <div class="main-container">
                <header class="header">
                    <div style="font-weight: bold; font-size: 18px;">{{ currentTitle }}</div>
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <el-popover placement="bottom" :width="300" trigger="click">
                            <template #reference><el-badge :value="invites.length" :hidden="invites.length===0"><el-icon style="font-size: 20px; cursor: pointer;"><Bell /></el-icon></el-badge></template>
                            <div v-if="invites.length===0" style="text-align: center; color:#999; padding:20px;">Êó†Ê∂àÊÅØ</div>
                            <div v-for="inv in invites" :key="inv.id" style="padding:10px; border-bottom:1px solid #eee;">
                                <div style="margin-bottom:5px;">ÈÇÄËØ∑Âä†ÂÖ•: <b>{{inv.name}}</b></div>
                                <el-button size="small" type="primary" @click="handleInvite(inv.id, true)">Êù•</el-button>
                                <el-button size="small" type="danger" plain @click="handleInvite(inv.id, false)">Êªö</el-button>
                            </div>
                        </el-popover>
                        <el-dropdown @command="handleUserMenu">
                            <div style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <el-avatar :size="30" :src="userInfo.avatar || 'https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png'"></el-avatar>
                                <span>{{ userInfo.username }}</span>
                            </div>
                            <template #dropdown><el-dropdown-menu><el-dropdown-item command="avatar">ÊîπÂ§¥ÂÉè</el-dropdown-item><el-dropdown-item command="logout" divided>ÈÄÄ‰∫Ü</el-dropdown-item></el-dropdown-menu></template>
                        </el-dropdown>
                    </div>
                </header>

                <div class="content-area">
                    <!-- È°πÁõÆÂàóË°® (ÁúÅÁï•‰øùÊåÅ) -->
                    <div v-if="view === 'my' || view === 'hall'">
                        <div style="margin-bottom: 20px; display: flex; justify-content: space-between;">
                            <div style="display: flex; gap: 10px;">
                                <span>{{ view==='hall'?'ÂπøÂú∫':'ÊàëÁöÑ' }}</span>
                                <el-input v-if="view==='hall'" v-model="searchKey" placeholder="Êêú‰∏Ä‰∏ã" style="width: 200px" @input="loadHall" clearable></el-input>
                            </div>
                            <el-button v-if="view==='my'" type="primary" icon="Plus" @click="showAddProject=true">ÊêûÈ°πÁõÆ</el-button>
                        </div>
                        <div class="project-grid">
                            <el-card v-for="p in projects" :key="p.id" class="p-card" shadow="hover" :body-style="{padding:'20px'}">
                                <el-button v-if="p.ownerId==userInfo.id" class="del-btn" icon="Delete" circle size="small" @click.stop="deleteProject(p)"></el-button>
                                <div @click="enterProject(p)" style="height: 100px;">
                                    <el-tag class="status-tag" :type="p.type===1?'success':'info'" @click.stop="toggleProjectType(p)">{{ p.type===1?'ÂÖ¨ÂºÄ':'ÁßÅÊúâ' }}</el-tag>
                                    <h3 style="margin:0 0 10px;">{{ p.name }}</h3>
                                    <p style="color:#666; font-size:13px; height:36px; overflow:hidden;">{{ p.description }}</p>
                                </div>
                                <div class="card-footer">
                                    <span style="font-size:12px; color:#999;">Boss: {{ p.ownerId }}</span>
                                    <div class="like-btn" :class="{'is-liked':p.isLiked}" @click.stop="toggleLike(p)">
                                        <el-icon><StarFilled v-if="p.isLiked"/><Star v-else/></el-icon><span>{{ p.likeCount||0 }}</span>
                                    </div>
                                </div>
                            </el-card>
                        </div>
                    </div>

                    <!-- ÁúãÊùø -->
                    <div v-if="view === 'board'" style="height: 100%; display: flex; flex-direction: column;">
                        <div style="margin-bottom: 20px; display: flex; justify-content: space-between;"><el-button icon="Back" @click="changeView('my')">Êí§ÈÄÄ</el-button><div v-if="isOwner"><el-button type="success" icon="UserPlus" @click="showInvite=true">Êëá‰∫∫</el-button></div></div>
                        <div class="board-wrapper">
                            <div class="kanban-container">
                                <div v-for="col in columns" :key="col.status" class="kb-column">
                                    <div class="kb-title">{{ col.label }} <el-button v-if="col.status===0 && isOwner" icon="Plus" circle size="small" @click="openAddTask"></el-button></div>
                                    <div class="task-list">
                                        <div v-for="task in (boardData[col.status] || [])" :key="task.id" class="task-item" @click="openTaskDetail(task)">
                                            <div style="font-weight: bold; margin-bottom: 8px;">{{ task.name }}</div>
                                            <div style="font-size: 12px; color: #666; margin-bottom: 10px;">{{ task.description }}</div>
                                            <div style="display: flex; justify-content: space-between; align-items: center;"><el-tag size="small" type="info">{{ task.assigneeId ? 'ID:'+task.assigneeId : 'Êú™ÊåáÊ¥æ' }}</el-tag>
                                                <div v-if="isOwner || task.assigneeId == userInfo.id" @click.stop>
                                                    <el-button-group><el-button v-if="task.status > 0" icon="ArrowLeft" size="small" circle @click="moveTask(task, task.status-1)"></el-button><el-button v-if="task.status < 2" icon="ArrowRight" size="small" circle @click="moveTask(task, task.status+1)"></el-button></el-button-group>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="member-sidebar">
                                <h4 style="margin-top:0;"><el-icon><UserFilled /></el-icon> ÊàêÂëò</h4>
                                <div v-for="m in members" :key="m.userId" class="member-item">
                                    <el-avatar :size="28" :src="m.avatar"></el-avatar>
                                    <div style="overflow: hidden;"><div style="font-size:13px;">{{ m.username }}</div><div style="font-size:10px; color:#999;">ID: {{ m.userId }}</div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‰ªªÂä°ËØ¶ÊÉÖÂºπÁ™ó -->
        <el-dialog v-model="showTaskDetail" title="ËØ¶ÊÉÖ" width="800px" destroy-on-close>
            <div class="task-detail-layout">
                <div class="detail-left">
                    <el-form label-position="top">
                        <el-form-item label="‰ªªÂä°Âêç"><el-input v-model="currentTask.name" :disabled="!canEditTask"></el-input></el-form-item>
                        <el-form-item label="ÊèèËø∞"><el-input v-model="currentTask.description" type="textarea" :rows="4" :disabled="!canEditTask"></el-input></el-form-item>
                        <el-form-item label="Âπ≤Ê¥ªÁöÑ (ID)"><el-input v-model="currentTask.assigneeId" :disabled="!isOwner"></el-input></el-form-item>
                        <div style="margin-top: 10px;"><label style="font-size: 14px; color: #606266;">ÈôÑ‰ª∂</label>
                            <div v-if="currentTask.fileUrl" class="file-box"><span style="flex:1; overflow:hidden;">{{ currentTask.fileName }}</span><el-button link type="primary" @click="downloadFile(currentTask.fileUrl, currentTask.fileName)">‰∏ãËΩΩ</el-button></div>
                            <el-button v-if="canEditTask" type="primary" plain size="small" icon="Upload" @click="triggerUpload" style="margin-top:5px;">‰∏ä‰º†</el-button>
                        </div>
                        <div style="margin-top: 20px; text-align: right;" v-if="canEditTask"><el-button type="primary" @click="saveTaskInfo">‰øùÂ≠ò</el-button></div>
                    </el-form>
                </div>
                <div class="detail-right">
                    <div style="font-weight: bold; margin-bottom: 10px;">ËÆ®ËÆ∫</div>
                    <div class="comment-list" ref="commentRef">
                        <div v-for="c in comments" :key="c.id" class="comment-item">
                            <el-avatar :size="24" :src="c.avatar"></el-avatar>
                            <div style="flex:1">
                                <div class="comment-meta">{{ c.username }} ¬∑ {{ formatDate(c.createTime) }}</div>
                                <div class="comment-content">{{ c.content }}</div>
                                <!-- üí° ËØÑËÆ∫Âà†Èô§ÊåâÈíÆ -->
                                <div v-if="c.userId == userInfo.id" class="comment-del-btn" @click="deleteComment(c.id)">Âà†Èô§</div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 10px;"><el-input v-model="newComment" placeholder="ËØ¥ÁÇπÂï•..." @keyup.enter="sendComment"><template #append><el-button @click="sendComment">Âèë</el-button></template></el-input></div>
                </div>
            </div>
        </el-dialog>

        <!-- ÂºπÁ™óÈõÜÁæ§ (‰øùÊåÅ) -->
        <el-dialog v-model="showAddProject" title="Êñ∞Âª∫" width="400px"><el-form :model="projectForm" label-position="top"><el-form-item label="Âêç"><el-input v-model="projectForm.name"></el-input></el-form-item><el-form-item label="Ëø∞"><el-input v-model="projectForm.description"></el-input></el-form-item><el-form-item label="Âûã"><el-radio-group v-model="projectForm.type"><el-radio :label="0">ÁßÅ</el-radio><el-radio :label="1">ÂÖ¨</el-radio></el-radio-group></el-form-item></el-form><template #footer><el-button @click="showAddProject=false">ÂÖ≥</el-button><el-button type="primary" @click="doAddProject">ÂºÄ</el-button></template></el-dialog>
        <el-dialog v-model="showAddTask" title="Âª∫‰ªªÂä°" width="400px"><el-form :model="taskForm" label-position="top"><el-form-item label="Ê†á"><el-input v-model="taskForm.name"></el-input></el-form-item><el-form-item label="Ëø∞"><el-input v-model="taskForm.description"></el-input></el-form-item><el-form-item label="‰∫∫"><el-input v-model="taskForm.assigneeId"></el-input></el-form-item></el-form><template #footer><el-button @click="showAddTask=false">ÂÖ≥</el-button><el-button type="primary" @click="doAddTask">ÂÆö</el-button></template></el-dialog>
        <el-dialog v-model="showInvite" title="Êëá‰∫∫" width="350px"><el-input v-model="inviteUsername" placeholder="Âêç"></el-input><template #footer><el-button type="primary" style="width: 100%" @click="doInvite">Âèë</el-button></template></el-dialog>
        <input type="file" ref="fileInput" style="display: none" @change="onFileChange" accept="image/*"><input type="file" ref="taskFileInput" style="display: none" @change="onTaskFileChange">
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, computed, nextTick } = Vue;
        const { ElMessage, ElNotification, ElMessageBox } = ElementPlus;

        createApp({
            setup() {
                const isLoggedIn = ref(!!localStorage.getItem('token'));
                const loading = ref(false);
                const authTab = ref('login');
                const view = ref('hall');
                const activeMenu = ref('hall');
                const searchKey = ref('');
                const userInfo = reactive({ id: localStorage.getItem('userId'), username: localStorage.getItem('username'), avatar: localStorage.getItem('avatar') });
                const projects = ref([]);
                const invites = ref([]);
                const members = ref([]);
                const boardData = ref({});
                const currentProject = ref({});
                const ws = ref(null);
                const showTaskDetail = ref(false);
                const currentTask = reactive({});
                const comments = ref([]);
                const newComment = ref('');
                const commentRef = ref(null);
                const loginForm = reactive({ username: '', password: '' });
                const regForm = reactive({ username: '', email: '', password: '' });
                const projectForm = reactive({ name: '', description: '', type: 0 });
                const taskForm = reactive({ name: '', description: '', assigneeId: null });
                const inviteUsername = ref('');
                const showAddProject = ref(false);
                const showAddTask = ref(false);
                const showInvite = ref(false);
                const fileInput = ref(null);
                const taskFileInput = ref(null);
                const columns = [{status:0, label:'Êë∏È±º‰∏≠'}, {status:1, label:'Êê¨Á†ñ‰∏≠'}, {status:2, label:'Êê¨ÂÆå‰∫Ü'}];
                const currentTitle = computed(() => (view.value === 'my' ? 'Âú∞Áõò' : view.value === 'hall' ? 'ÂπøÂú∫' : 'Áé∞Âú∫'));
                const isOwner = computed(() => currentProject.value.ownerId == userInfo.id);
                const canEditTask = computed(() => isOwner.value || currentTask.assigneeId == userInfo.id);

                axios.defaults.baseURL = '';
                axios.interceptors.request.use(cfg => { if(localStorage.getItem('token')) cfg.headers.token = localStorage.getItem('token'); return cfg; });
                axios.interceptors.response.use(res => { if(res.data.code !== 200) { ElMessage.error(res.data.msg); return Promise.reject(); } return res.data; }, err => { if(err.response?.status === 401) { localStorage.clear(); isLoggedIn.value = false; } return Promise.reject(err); });

                const handleLogin = async () => { try { loading.value=true; const res = await axios.post('/user/login', loginForm); localStorage.setItem('token', res.data.token); localStorage.setItem('userId', res.data.id); localStorage.setItem('username', res.data.username); localStorage.setItem('avatar', res.data.avatar || ''); window.location.reload(); } finally { loading.value=false; } };
                const handleRegister = async () => { await axios.post('/user/register', regForm); ElMessage.success('Ê≥®ÂÜåÊàêÂäü'); authTab.value = 'login'; };
                const changeView = (v) => { view.value = v; activeMenu.value = v; if(v === 'my') loadMyProjects(); if(v === 'hall') loadHall(); };
                const loadMyProjects = async () => { const res = await axios.get('/project/list'); projects.value = res.data; };
                const loadHall = async () => { const res = await axios.get('/project/hall', { params: { keyword: searchKey.value } }); projects.value = res.data; };
                const toggleLike = async (p) => { await axios.post(`/project/like/${p.id}`); p.isLiked = !p.isLiked; p.likeCount += (p.isLiked ? 1 : -1); };
                const enterProject = (p) => { currentProject.value = p; view.value = 'board'; loadBoard(p.id); loadMembers(p.id); initWS(p.id); };
                const loadBoard = async (pid) => { const res = await axios.get(`/task/board/${pid}`); boardData.value = res.data; };
                const loadMembers = async (pid) => { const res = await axios.get(`/project/members/${pid}`); members.value = res.data; };
                const doAddProject = async () => { await axios.post('/project/create', projectForm); showAddProject.value = false; changeView('my'); };
                const openAddTask = () => { taskForm.name=''; taskForm.description=''; taskForm.assigneeId=''; showAddTask.value=true; };
                const doAddTask = async () => { await axios.post('/task/create', { ...taskForm, projectId: currentProject.value.id }); showAddTask.value = false; loadBoard(currentProject.value.id); };
                const moveTask = async (t, s) => { await axios.post('/task/update', { taskId: t.id, status: s }); loadBoard(currentProject.value.id); };
                const doInvite = async () => { await axios.post('/project/invite', { projectId: currentProject.value.id, username: inviteUsername.value }); showInvite.value = false; ElMessage.success('Â∑≤Âèë'); };
                const handleInvite = async (pid, accept) => { await axios.post('/project/invite/handle', { projectId: pid, accept }); loadInvites(); if(accept) loadMyProjects(); };
                const loadInvites = async () => { const res = await axios.get('/project/invite/list'); invites.value = res.data; };
                const handleUserMenu = (cmd) => { if(cmd === 'logout') { localStorage.clear(); location.reload(); } if(cmd === 'avatar') fileInput.value.click(); };
                const onFileChange = async (e) => { const file = e.target.files[0]; if(!file) return; const fd = new FormData(); fd.append('file', file); const res = await axios.post('/user/upload/avatar', fd); userInfo.avatar = res.data; localStorage.setItem('avatar', res.data); ElMessage.success('Êàê‰∫Ü'); };
                const downloadFile = (url, name) => { if(!url) return; const link = document.createElement('a'); link.href = url; link.setAttribute('download', name || 'file'); link.target = '_blank'; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
                const deleteProject = (p) => { ElMessageBox.confirm('Âà†Ôºü', 'Ë≠¶Âëä', { confirmButtonText: 'Âà†', type: 'warning' }).then(async () => { await axios.delete(`/project/${p.id}`); ElMessage.success('Âà†‰∫Ü'); if(view.value==='my') loadMyProjects(); else loadHall(); }); };
                const toggleProjectType = async (p) => { if (p.ownerId != userInfo.id) return; const newType = p.type === 1 ? 0 : 1; await axios.post('/project/type', { id: p.id, type: newType }); p.type = newType; ElMessage.success('Êîπ‰∫Ü'); };

                const openTaskDetail = async (t) => { Object.assign(currentTask, t); showTaskDetail.value = true; loadComments(t.id); };
                const loadComments = async (tid) => { const res = await axios.get(`/task/comment/list/${tid}`); comments.value = res.data; scrollToBottom(); };
                const sendComment = async () => { if (!newComment.value.trim()) return; await axios.post('/task/comment/add', { taskId: currentTask.id, content: newComment.value }); newComment.value = ''; loadComments(currentTask.id); };
                // üí° Âà†Èô§ËØÑËÆ∫
                const deleteComment = async (cid) => { await axios.delete(`/task/comment/${cid}`); ElMessage.success('Âà†‰∫Ü'); loadComments(currentTask.id); };
                
                const saveTaskInfo = async () => { await axios.post('/task/update', { taskId: currentTask.id, name: currentTask.name, description: currentTask.description, assigneeId: currentTask.assigneeId }); ElMessage.success('Â≠ò‰∫Ü'); loadBoard(currentProject.value.id); };
                const triggerUpload = () => { taskFileInput.value.click(); };
                const onTaskFileChange = async (e) => { const file = e.target.files[0]; if(!file) return; const fd = new FormData(); fd.append('file', file); await axios.post(`/task/upload/file/${currentTask.id}`, fd); currentTask.fileUrl = 'loading...'; ElMessage.success('‰º†‰∫Ü'); loadBoard(currentProject.value.id); showTaskDetail.value=false; };
                const scrollToBottom = () => { nextTick(() => { if(commentRef.value) commentRef.value.scrollTop = commentRef.value.scrollHeight; }); };
                const formatDate = (d) => d ? new Date(d).toLocaleString() : '';
                const initWS = (pid) => { if(ws.value) ws.value.close(); ws.value = new WebSocket(`ws://${location.host}/ws/${pid}/${parseInt(userInfo.id)}`); ws.value.onmessage = (e) => { if (e.data.startsWith('comment:')) { const tid = e.data.split(':')[1]; if (showTaskDetail.value && currentTask.id == tid) loadComments(tid); } else if (e.data.includes('refresh')) loadBoard(pid); }; };

                onMounted(() => { if(isLoggedIn.value) { changeView('hall'); loadInvites(); } });

                return {
                    isLoggedIn, authTab, loading, view, activeMenu, userInfo, projects, invites, members, boardData,
                    loginForm, regForm, projectForm, taskForm, inviteUsername, showAddProject, showAddTask, showInvite,
                    currentTitle, columns, isOwner, fileInput, taskFileInput, searchKey,
                    handleLogin, handleRegister, changeView, enterProject, doAddProject, doAddTask, moveTask,
                    doInvite, handleInvite, handleUserMenu, onFileChange, loadHall, toggleLike, triggerUpload, onTaskFileChange,
                    downloadFile, deleteProject, toggleProjectType,
                    showTaskDetail, currentTask, comments, newComment, commentRef, openTaskDetail, sendComment, saveTaskInfo, formatDate,
                    canEditTask, openAddTask, deleteComment
                };
            }
        }).use(ElementPlus).component('Menu', ElementPlusIconsVue.Menu).component('Compass', ElementPlusIconsVue.Compass).component('Plus', ElementPlusIconsVue.Plus).component('Bell', ElementPlusIconsVue.Bell).component('Back', ElementPlusIconsVue.Back).component('ArrowRight', ElementPlusIconsVue.ArrowRight).component('ArrowLeft', ElementPlusIconsVue.ArrowLeft).component('User', ElementPlusIconsVue.User).component('Search', ElementPlusIconsVue.Search).component('Star', ElementPlusIconsVue.Star).component('StarFilled', ElementPlusIconsVue.StarFilled).component('UserFilled', ElementPlusIconsVue.UserFilled).component('UserPlus', ElementPlusIconsVue.UserFilled).component('Upload', ElementPlusIconsVue.Upload).component('Document', ElementPlusIconsVue.Document).component('Delete', ElementPlusIconsVue.Delete).component('Edit', ElementPlusIconsVue.Edit).mount('#app');
    </script>
</body>
</html>